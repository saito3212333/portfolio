# /// script
# dependencies = ["pandas", "pywin32"]
# ///

import os
import datetime
import pandas as pd
import win32com.client as win32

# ==========================================
# âš™ï¸ è¨­å®š
# ==========================================
TODAY = datetime.date.today()
CSV_FILE = f"daily_news_{TODAY.strftime('%Y%m%d')}.csv"
TO_ADDRESS = "test@example.com" # ãƒ†ã‚¹ãƒˆé€ä¿¡å…ˆ

# ã‚«ãƒ†ã‚´ãƒªã”ã¨ã®ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼
COLORS = {
    "1. æ—§é›»åŠ›ãƒ—ãƒ¬ã‚¹": "#3498db",  
    "2. OCCTOã®ã¿": "#e67e22",     
    "3. æ–°é›»åŠ›ãŠã—ã‚‰ã›": "#27ae60", 
    "4. æ—§é›»åŠ›ã®ãŠçŸ¥ã‚‰ã›": "#9b59b6"  
}

def create_html_body(df):
    """ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‹ã‚‰ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆè¡¨ï¼‰å½¢å¼ã®HTMLãƒ¡ãƒ¼ãƒ«æœ¬æ–‡ã‚’ç”Ÿæˆã™ã‚‹"""
    html = f"""
    <html>
    <body style="font-family: 'Meiryo', sans-serif; color: #333; line-height: 1.6;">
        <p>æœ¬æ—¥ã®æ–°ç€ãƒ‹ãƒ¥ãƒ¼ã‚¹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚</p>
    """
    
    # ã‚«ãƒ†ã‚´ãƒªã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¦è¡¨ç¤º
    grouped = df.groupby('ã‚°ãƒ«ãƒ¼ãƒ—ã‚«ãƒ†ã‚´ãƒª')
    for category, group in grouped:
        color = COLORS.get(category, "#555555")
        
        # ã‚«ãƒ†ã‚´ãƒªã‚¿ã‚¤ãƒˆãƒ«
        html += f'<h3 style="color: {color}; margin-top: 30px; border-bottom: 2px solid {color}; padding-bottom: 5px;">ã€ {category} ã€‘</h3>'
        
        # ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆè¡¨ï¼‰ã®é–‹å§‹
        html += """
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 0.95em;">
            <thead>
                <tr style="background-color: #f2f2f2;">
                    <th style="border: 1px solid #dddddd; padding: 8px; text-align: center; width: 12%; white-space: nowrap;">æ—¥ä»˜</th>
                    <th style="border: 1px solid #dddddd; padding: 8px; text-align: center; width: 15%; white-space: nowrap;">é›»åŠ›ä¼šç¤¾</th>
                    <th style="border: 1px solid #dddddd; padding: 8px; text-align: left;">ã‚¿ã‚¤ãƒˆãƒ«</th>
                </tr>
            </thead>
            <tbody>
        """
        
        # è¡Œã®è¿½åŠ 
        for _, row in group.iterrows():
            date_str = row['æ—¥ä»˜']
            company = row['é›»åŠ›ä¼šç¤¾']
            title = row['ã‚¿ã‚¤ãƒˆãƒ«']
            url = row['URL']
            
            html += f"""
                <tr>
                    <td style="border: 1px solid #dddddd; padding: 8px; text-align: center; white-space: nowrap;">{date_str}</td>
                    <td style="border: 1px solid #dddddd; padding: 8px; text-align: center; white-space: nowrap;">{company}</td>
                    <td style="border: 1px solid #dddddd; padding: 8px;">
                        <a href="{url}" target="_blank" style="color: #0056b3; text-decoration: none;">{title}</a>
                    </td>
                </tr>
            """
        
        # ãƒ†ãƒ¼ãƒ–ãƒ«ã®çµ‚äº†
        html += """
            </tbody>
        </table>
        """

    html += """
        <br>
        <hr style="border: none; border-top: 1px solid #eee;">
        <p style="font-size: 0.8em; color: #999;">â€»ã“ã®ãƒ¡ãƒ¼ãƒ«ã¯Pythonè‡ªå‹•åé›†ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã‚‹è‡ªå‹•é…ä¿¡ã§ã™ã€‚</p>
    </body>
    </html>
    """
    return html

def send_outlook_mail():
    if not os.path.exists(CSV_FILE):
        print(f"ğŸ“­ æœ¬æ—¥ã®ãƒ•ã‚¡ã‚¤ãƒ« ({CSV_FILE}) ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚")
        return

    df = pd.read_csv(CSV_FILE)
    if df.empty:
        print("ğŸ“­ æ–°ç€ãƒ‹ãƒ¥ãƒ¼ã‚¹ãŒ0ä»¶ã®ãŸã‚ã€ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚")
        return

    html_body = create_html_body(df)

    print("âœ‰ï¸ Outlookã‚’èµ·å‹•ã—ã¦ãƒ¡ãƒ¼ãƒ«ã‚’ä½œæˆä¸­...")
    try:
        outlook = win32.Dispatch('outlook.application')
        mail = outlook.CreateItem(0)
        
        mail.To = TO_ADDRESS
        mail.Subject = f"âš¡ ã€æœ¬æ—¥ã®æ–°ç€ã€‘é›»åŠ›ãƒ»ã‚¬ã‚¹æ¥­ç•Œãƒ‹ãƒ¥ãƒ¼ã‚¹ï¼ˆ{TODAY.strftime('%Yå¹´%mæœˆ%dæ—¥')}ï¼‰"
        mail.HTMLBody = html_body
        
        # ã¾ãšã¯ç”»é¢ã«è¡¨ç¤ºã—ã¦ç¢ºèªï¼ˆæ‰‹å‹•é€ä¿¡ï¼‰
        mail.Display(True) 
        print("âœ… Outlookã§ãƒ¡ãƒ¼ãƒ«ä½œæˆç”»é¢ã‚’é–‹ãã¾ã—ãŸï¼")
        
    except Exception as e:
        print(f"âŒ Outlookèµ·å‹•ã‚¨ãƒ©ãƒ¼: {e}")

if __name__ == "__main__":
    send_outlook_mail()
